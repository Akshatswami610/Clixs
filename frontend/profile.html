{% extends "basic.html" %}

{% block title %}Clixs - Profile{% endblock %}

{% block extra_styles %}
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 3rem 2rem;
}

.profile-header {
    background: rgba(30, 30, 45, 0.8);
    padding: 2.5rem;
    border-radius: 20px;
    margin-bottom: 3rem;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
    animation: fadeIn 0.6s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.profile-title {
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(135deg, #3498db, #9b59b6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 1.5rem;
}

.profile-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.info-item {
    background: rgba(20, 20, 30, 0.6);
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid rgba(52, 152, 219, 0.2);
}

.info-label {
    color: #00d4ff;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.info-value {
    font-size: 1.2rem;
    font-weight: 600;
}

.logout-btn {
    margin-top: 1.5rem;
    padding: 0.8rem 2rem;
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    border: none;
    border-radius: 12px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.logout-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(231, 76, 60, 0.5);
}

.section-title {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 2rem;
    color: #ffffff;
}

.items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 2rem;
}

.item-card {
    background: rgba(30, 30, 45, 0.8);
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
    transition: all 0.3s ease;
}

.item-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(52, 152, 219, 0.3);
}

.item-title {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.item-status {
    display: inline-block;
    padding: 0.3rem 0.8rem;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 1rem;
}

.status-active {
    background: linear-gradient(135deg, #27ae60, #229954);
}

.status-sold {
    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
}

.status-rented {
    background: linear-gradient(135deg, #f39c12, #e67e22);
}

.item-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
}

.action-btn {
    flex: 1;
    padding: 0.6rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.edit-btn {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
}

.delete-btn {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
}

.loading {
    text-align: center;
    padding: 3rem;
    font-size: 1.2rem;
    color: #00d4ff;
}

@media (max-width: 768px) {
    .profile-header {
        padding: 1.5rem;
    }

    .profile-info {
        grid-template-columns: 1fr;
    }

    .items-grid {
        grid-template-columns: 1fr;
    }
}
{% endblock %}

{% block content %}
<div class="container">
    <div class="profile-header">
        <h1 class="profile-title">My Profile</h1>
        <div class="profile-info" id="profileInfo">
            <div class="loading">Loading profile...</div>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <h2 class="section-title">My Items</h2>
    <div class="items-grid" id="userItems">
        <div class="loading">Loading items...</div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
const API_BASE = '/api/v1';

function checkAuthRequired() {
    const token = localStorage.getItem('authToken');
    if (!token) {
        alert('Please login to view your profile');
        location.href = 'login.html';
        return false;
    }
    return true;
}

async function loadProfile() {
    if (!checkAuthRequired()) return;

    const token = localStorage.getItem('authToken');
    const profileInfo = document.getElementById('profileInfo');

    try {
        const response = await fetch(`${API_BASE}/auth/profile/`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error('Failed to load profile');
        }

        const user = await response.json();
        localStorage.setItem('user', JSON.stringify(user));

        document.getElementById('userInitial').textContent = user.first_name.charAt(0).toUpperCase();

        profileInfo.innerHTML = `
            <div class="info-item">
                <div class="info-label">Full Name</div>
                <div class="info-value">${user.first_name} ${user.last_name}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Phone Number</div>
                <div class="info-value">${user.phone_number}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Registration Number</div>
                <div class="info-value">${user.registration_number}</div>
            </div>
        `;
    } catch (error) {
        console.error('Error loading profile:', error);
        profileInfo.innerHTML = '<div class="loading" style="color: #e74c3c;">Failed to load profile</div>';
    }
}

async function loadUserItems() {
    if (!checkAuthRequired()) return;

    const token = localStorage.getItem('authToken');
    const itemsContainer = document.getElementById('userItems');

    try {
        const response = await fetch(`${API_BASE}/items/`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error('Failed to load items');
        }

        const items = await response.json();
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        // Filter items by current user
        const userItems = items.filter(item => item.user_id === user.id);

        if (userItems.length === 0) {
            itemsContainer.innerHTML = '<div class="loading">No items yet</div>';
            return;
        }

        itemsContainer.innerHTML = userItems.map(item => {
            const statusClass = item.status === 'ACTIVE' ? 'status-active' : 
                               item.status === 'SOLD' ? 'status-sold' : 'status-rented';
            
            return `
                <div class="item-card">
                    <div class="item-title">${item.title}</div>
                    <span class="item-status ${statusClass}">${item.status}</span>
                    <div style="color: #b0b0b0; margin-top: 0.5rem;">
                        ${item.category} â€¢ ${item.item_type}
                    </div>
                    <div class="item-actions">
                        <button class="action-btn edit-btn" onclick="editItem(${item.id})">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteItem(${item.id})">Delete</button>
                    </div>
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading items:', error);
        itemsContainer.innerHTML = '<div class="loading" style="color: #e74c3c;">Failed to load items</div>';
    }
}

function editItem(itemId) {
    alert('Edit functionality coming soon!');
    // TODO: Implement edit modal
}

async function deleteItem(itemId) {
    if (!confirm('Are you sure you want to delete this item?')) return;

    const token = localStorage.getItem('authToken');

    try {
        const response = await fetch(`${API_BASE}/items/${itemId}/`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error('Failed to delete item');
        }

        alert('Item deleted successfully!');
        loadUserItems();
    } catch (error) {
        console.error('Error deleting item:', error);
        alert('Failed to delete item');
    }
}

function logout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('user');
    location.href = 'index.html';
}

// Initialize
checkAuthRequired();
loadProfile();
loadUserItems();
{% endblock %}